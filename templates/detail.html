{% extends 'base.html' %}

{% block content %}
<div class="container" style="margin-top: 50px;">
    <div class="detail-wrapper">
        <div class="detail-image">
            <img src="/product_image/{{ product.id }}" id="product-img" alt="{{ product.name }}" onerror="this.src='https://via.placeholder.com/500x500?text=No+Image'">
        </div>

        <div class="detail-info">
            <div class="info-header">
                <span class="detail-brand">{{ product.brand }}</span>
                <h1 class="detail-title" id="product-name">{{ product.name }}</h1>
                <p class="detail-price">
                    <span class="price-amount" data-usd="{{ product.price }}">${{ product.price }}</span>
                </p>
            </div>

            <div class="detail-desc">
                <p>{{ product.description }}</p>
                <p style="margin-top: 10px; color: #888; font-size: 13px;">
                    üöÄ Free Shipping | ‚úÖ Guaranteed Next Day Delivery
                </p>
            </div>
            <div class="detail-desc" style="border-top: none; margin-top: -15px;">
                {% if user_pets|length > 1 %}
                <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                    <p style="font-size: 13px; color: #856404; margin-bottom: 8px;">
                        üêï Choose pet for size recommendation:
                    </p>
                    <select onchange="window.location.href='/product/{{ product.id }}?pet_id=' + this.value" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; width: 100%;">
                        <option value="">Select a pet...</option>
                        {% for pet in user_pets %}
                        <option value="{{ pet.id }}" {% if selected_pet and pet.id == selected_pet.id %}selected{% endif %}>{{ pet.name }} - {{ pet.breed_name or 'Unknown breed' }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                
                <p style="font-size: 13px; color: #555; margin-bottom: 8px;">
                    Choose Size
                    {% if recommended_size and selected_pet %}
                    <span style="color: #4CAF50; font-weight: 600; margin-left: 8px;">‚úì Recommended for {{ selected_pet.name }}: {{ recommended_size }}</span>
                    {% endif %}
                </p>
                <div class="size-picker" id="product-size-picker">
                    {% if product.sizes %}
                        {% for size in product.sizes %}
                            <button type="button" class="size-option{% if size.label == recommended_size %} is-active{% elif not recommended_size and size.label == 'M' %} is-active{% endif %}" data-size="{{ size.label }}">
                                {{ size.label }}
                            </button>
                        {% endfor %}
                    {% else %}
                        <button type="button" class="size-option" data-size="S">S</button>
                        <button type="button" class="size-option is-active" data-size="M">M</button>
                        <button type="button" class="size-option" data-size="L">L</button>
                    {% endif %}
                </div>
                <span id="product-size" class="size-selected" data-input-id="cart-size">{{ recommended_size or product.size or 'M' }}</span>
            </div>

            <div class="btn-group">
                <form action="/cart/add/{{ product.id }}" method="POST" class="cart-form">
                    <input type="hidden" name="size" id="cart-size" value="{{ recommended_size or product.size or 'M' }}">
                    <input type="hidden" name="qty" value="1">
                    <button type="submit" class="btn-cart">Add to Cart</button>
                </form>
                <button class="btn-buy" type="button" onclick="location.href='/cart'">Buy Now</button>
            </div>

            <div class="ai-section">
                {% if user_pets|length == 0 %}
                <p style="color: #888; font-size: 13px;">Add a pet profile to try AI virtual fitting</p>
                {% elif user_pets|length == 1 %}
                <button type="button" class="btn-ai" onclick="tryAIFitting({{ user_pets[0].id }}, '{{ user_pets[0].name|e }}')">
                    üëï Try AI Virtual Fitting with {{ user_pets[0].name }}
                </button>
                <p class="ai-msg">üîÆ Try it on your dog with AI!</p>
                {% else %}
                <button type="button" class="btn-ai" onclick="showPetSelector()">
                    üëï Try AI Virtual Fitting
                </button>
                <p class="ai-msg">üîÆ Choose a pet to try it on!</p>
                <div id="pet-selector-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 24px; border-radius: 12px; max-width: 400px; width: 90%;">
                        <h3 style="margin-bottom: 16px;">Choose a pet for AI fitting:</h3>
                        {% for pet in user_pets %}
                        <div onclick="tryAIFitting({{ pet.id }}, '{{ pet.name|e }}')" style="padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px;">
                            {% if pet.image_data %}
                            <img src="/pet_image/{{ pet.id }}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                            {% endif %}
                            <div>
                                <strong>{{ pet.name }}</strong><br>
                                <small style="color: #888;">{{ pet.breed_name or 'Unknown breed' }}</small>
                            </div>
                        </div>
                        {% endfor %}
                        <div class="ai-confirm-actions" style="margin-top: 12px;">
                            <button class="btn-outline btn-large ai-cancel-btn" onclick="closePetSelector()">Cancel</button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Size Chart -->
            <div style="margin-top: 24px; padding: 20px; background: white; border: 1px solid #e0e0e0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">üìè Size Chart</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #f8f9fa; text-align: left;">
                                <th style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">Size</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">Chest</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">Back</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6; font-weight: 600;">Weight (kg)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for size in product.sizes %}
                            <tr style="{% if size.label == recommended_size %}background: #e7f5e7;{% endif %}">
                                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: 700;">
                                    {{ size.label }}
                                    {% if size.label == recommended_size %}
                                    <span style="color: #4CAF50; margin-left: 4px; font-size: 11px;">‚úì</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 10px; border: 1px solid #dee2e6;">{{ size.chest_cm }}cm</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6;">{{ size.back_cm }}cm</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6;">
                                    {% if size.weight_min_kg and size.weight_max_kg %}
                                    {{ size.weight_min_kg }}-{{ size.weight_max_kg }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 12px; font-size: 11px; color: #888; line-height: 1.4;">
                    üí° Measure chest around widest part ‚Ä¢ Back from neck to tail base
                </p>
            </div>
        </div>
    </div>
</div>

<div id="ai-loading-overlay" class="ai-loading-overlay" style="display:none;">
    <div class="ai-loading-card">
        <div class="spinner"></div>
        <p id="detail-progress-label">Outfitting your pet... üß∂</p>
        <div class="progress-wrap">
            <div id="detail-progress-bar" class="progress-bar"></div>
        </div>
        <p id="detail-progress-text" class="progress-text">0%</p>
        {% if preview_products|length > 0 %}
        <div class="ai-wait-recos">
            <p class="ai-wait-title">Recommended while you wait</p>
            <div class="ai-wait-grid">
                {% for item in preview_products %}
                <a href="/product/{{ item.id }}" class="ai-wait-card">
                    <img src="/product_image/{{ item.id }}" alt="{{ item.name }}">
                    <div class="ai-wait-info">
                        <span class="ai-wait-name">{{ item.name }}</span>
                        <span class="ai-wait-brand">{{ item.brand or 'SNAPET' }}</span>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div id="ai-confirm-modal" class="ai-confirm-modal" style="display:none;">
    <div class="ai-confirm-card">
        <h3>Confirm AI Fitting</h3>
        <p id="ai-confirm-text">Start AI fitting?</p>
        <div class="ai-confirm-actions">
            <button class="btn-black btn-large ai-action-btn" onclick="confirmAIFitting()">Start</button>
            <button class="btn-outline btn-large ai-action-btn" onclick="closeAIFittingConfirm()">Cancel</button>
        </div>
    </div>
</div>

<script>
function showPetSelector() {
    document.getElementById('pet-selector-modal').style.display = 'flex';
}

function closePetSelector() {
    document.getElementById('pet-selector-modal').style.display = 'none';
}

let pendingPetSelection = null;

function tryAIFitting(petId, petName) {
    pendingPetSelection = { petId, petName };
    openAIFittingConfirm(petName);
    return false;
}

function openAIFittingConfirm(petName) {
    const confirmModal = document.getElementById('ai-confirm-modal');
    const confirmText = document.getElementById('ai-confirm-text');
    if (confirmText) {
        const nameLabel = petName || 'this pet';
        confirmText.textContent = `Start AI fitting for ${nameLabel}?`;
    }
    if (confirmModal) {
        confirmModal.style.display = 'flex';
    }
}

function closeAIFittingConfirm() {
    const confirmModal = document.getElementById('ai-confirm-modal');
    if (confirmModal) {
        confirmModal.style.display = 'none';
    }
}

function confirmAIFitting() {
    if (!pendingPetSelection) {
        closeAIFittingConfirm();
        return;
    }
    runAIFitting(pendingPetSelection.petId, pendingPetSelection.petName);
    pendingPetSelection = null;
    closeAIFittingConfirm();
}

function runAIFitting(petId, petName) {
    if (document.getElementById('pet-selector-modal')) {
        closePetSelector();
    }
    
    const loadingOverlay = document.getElementById('ai-loading-overlay');
    const detailProgressBar = document.getElementById('detail-progress-bar');
    const detailProgressText = document.getElementById('detail-progress-text');
    const detailProgressLabel = document.getElementById('detail-progress-label');
    let detailTimer = null;

    function startDetailProgress() {
        if (!detailProgressBar || !detailProgressText) return;
        const start = Date.now();
        const rampMs = 13000;
        let lastValue = 6;
        detailTimer = setInterval(() => {
            const elapsed = Date.now() - start;
            const ratio = Math.min(1, elapsed / rampMs);
            const target = 6 + 84 * ratio;
            const jitter = (Math.random() * 6) - 3;
            const nextValue = Math.max(lastValue, Math.floor(target + jitter));
            lastValue = Math.min(90, nextValue);
            detailProgressBar.style.width = lastValue + "%";
            detailProgressText.textContent = lastValue + "%";
        }, 200);
    }

    function stopDetailProgress() {
        if (!detailProgressBar || !detailProgressText) return;
        if (detailTimer) {
            clearInterval(detailTimer);
            detailTimer = null;
        }
        detailProgressBar.style.width = "100%";
        detailProgressText.textContent = "100%";
    }

    if (detailProgressLabel && petName) {
        detailProgressLabel.textContent = `Outfitting ${petName}... üß∂`;
    }
    if (loadingOverlay) {
        loadingOverlay.style.display = "flex";
        startDetailProgress();
    }

    // Show loading state
    const aiBtns = document.querySelectorAll('.btn-ai');
    aiBtns.forEach(btn => {
        btn.innerHTML = '‚è≥ Outfitting your pet...';
        btn.disabled = true;
    });
    
    // Get product info
    const productName = document.getElementById('product-name').textContent;
    const productImageUrl = document.getElementById('product-img').src;
    
    // Call the AI fitting API
    const formData = new FormData();
    formData.append('pet_id', petId);
    formData.append('product_name', productName);
    formData.append('product_image_url', productImageUrl);
    
    fetch('/api/fit_clothing', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.result_image) {
            // Show result in a modal or replace product image temporarily
            const resultModal = document.createElement('div');
            resultModal.className = 'ai-result-modal';
            const displayName = petName || 'Your pet';
            resultModal.innerHTML = `
                <div class="ai-result-card">
                    <div class="ai-result-header">
                        <p>AI Virtual Try-On</p>
                        <h3>${displayName} tried it on!</h3>
                    </div>
                    <div class="ai-result-media">
                        <img src="${data.result_image}" alt="AI result">
                    </div>
                    <div class="ai-result-actions">
                        <button class="btn-black btn-large" onclick="downloadAIResult('${data.result_image}')">Download</button>
                        <button class="btn-outline btn-large" onclick="this.closest('.ai-result-modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(resultModal);
        } else {
            alert('AI fitting failed. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating AI image. Please try again.');
    })
    .finally(() => {
        if (loadingOverlay) {
            stopDetailProgress();
            loadingOverlay.style.display = "none";
        }
        aiBtns.forEach(btn => {
            btn.innerHTML = 'üëï Try AI Virtual Fitting';
            btn.disabled = false;
        });
    });
    
    // Prevent the old modal from opening
    return false;
}

function downloadAIResult(imageUrl) {
    fetch(imageUrl)
        .then(response => response.blob())
        .then(blob => {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'ai_result.jpg';
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
        })
        .catch(err => {
            console.error(err);
            alert('Download failed. Please try again.');
        });
}
</script>


{% endblock %}
